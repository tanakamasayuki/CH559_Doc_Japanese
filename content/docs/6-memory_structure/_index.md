---
title: 6. メモリ構造
type: docs
weight: 6
BookToC: false
---

# 6. メモリ構造

## 6.1 メモリ空間

CH559のアドレス空間は、プログラム保存空間、内部データ保存空間、外部データ保存空間に分けられている。

<div>
    <p align="center">図 6.1 メモリ構造</p>
</div>

![Memory_structure](/docs/6-memory_structure/images/mem_struct.png "Memory structure")

## 6.2 プログラム記憶空間

プログラムメモリ領域は64KBです。図6.1に示すように、命令コードを保存するコードフラッシュ領域、不揮発性データを保存するデータフラッシュ領域、構成情報を保存する構成情報領域など、すべてフラッシュROMに使用されます。

データフラッシュのアドレス範囲はF000h～F3FFHです。1バイト読み込み(8ビット)、2バイト書き込み(16ビット)、ブロック削除(1Kバイト)動作をサポートしています。チップの電源を切ってもデータは変化しません。

コードフラッシュには、ローアドレス領域用のアプリケーションコードとハイアドレス領域用のブートストラップコードがあります。また、これら2つの領域とデータフラッシュを組み合わせて、1つのアプリケーションコードを保持することもできます。

構成情報は必要に応じてプログラマが設定する合計16ビットのデータで表6.2を参照してください。

<div>
    <p align="center">表6.2 フラッシュROMの構成情報の説明</p>
</div>

<table>
    <tr>
        <th>ビット</th><th>名前</th><th>説明</th><th>リセット値</th>
    </tr>
    <tr><td>15</td><td>Code_Protect</td><td>フラッシュROMのコードとデータ保護モード:<br>0-プログラマが読み取ることを禁止する、プログラムは秘密です<br>1-読み出しを許可</td><td>0/1</td></tr>
    <tr><td>14</td><td>No_Boot_Load</td><td>BootLoader ブートコード起動モードを許可:<br>0-0000hアドレスのアプリケーションから起動<br>1-F400hアドレスのブートローダから起動</td><td>1</td></tr>
    <tr><td>13</td><td>En_Long_Reset</td><td>パワーオンリセット時の追加遅延リセットを許可:<br>0-スタンダードショートリセット<br>1-ワイドリセット、87mSリセット時間追加</td><td>0</td></tr>
    <tr><td>12</td><td>XT_OSC_Strong</td><td>水晶振動子の外部駆動を選択:<br>0-基本<br>1-拡張</td><td>0</td></tr>
    <tr><td>11</td><td>En_P5.7_RESET</td><td>マニュアルリセット入力端子としてP5.7を有効:<br>0-無効<br>1-リセット有効</td><td>1</td></tr>
    <tr><td>10</td><td>En_P0_Pullup</td><td>システムリセット時にポートP0の内部プルアップ抵抗を有効:<br>0-リセット後、プルアップ抵抗は無効<br>1-リセット後、プルアップ抵抗が有効</td><td>1</td></tr>
    <tr><td>9</td><td>Must_1</td><td>(必要に応じてプログラマが自動的に1に設定)</td><td>1</td></tr>
    <tr><td>8</td><td>Must_0</td><td>(必要に応じてプログラマが自動的に0に設定)</td><td>0</td></tr>
    <tr><td>[7:0]</td><td>All_1</td><td>(必要に応じてプログラマが自動的にFFhに設定)</td><td>FFh</td></tr>
</table>

## 6.3 データ保存領域

内部データ記憶領域は合計256バイトです。図6.1に示すように、SFRとiRAMに使用します。iRAMはスタックや高速データの一時記憶に使用されます。作業レジスタR0～R7、ビット変数bdata、バイト変数data、idataなどに細分化することができます。

外部データ保存領域は、図6.1に示すように合計64KBで、一部はxRAMとxSFRの6KBのオンチップ拡張に使用されます。2つの予約領域を除いて、残りの4000h～FFFFFhのアドレス範囲が外部バス領域となります。

## 6.4 フラッシュROMレジスタ

<div>
    <p align="center">表6.4 フラッシュROMオペレーションレジスタ一覧</p>
</div>

<table>
    <tr>
        <th>名前</th><th>アドレス</th><th>説明</th><th>リセット値</th>
    </tr>
    <tr><td>ROM_DATA_H</td><td>8Fh</td><td>フラッシュROMデータレジスタ上位バイト</td><td>xxh</td></tr>
    <tr><td>ROM_DATA_L</td><td>8Eh</td><td>フラッシュROMデータレジスタ下位バイト</td><td>xxh</td></tr>
    <tr><td>ROM_DATA</td><td>8Eh</td><td>ROM_DATA_LとROM_DATA_Hで16ビットSFR</td><td>xxxxh</td></tr>
    <tr><td>ROM_STATUS</td><td>86h</td><td>フラッシュROMステータスレジスタ(読み取り専用)</td><td>80h</td></tr>
    <tr><td>ROM_CTRL</td><td>86h</td><td>フラッシュROM制御レジスタ(書き込み専用)</td><td>00h</td></tr>
    <tr><td>ROM_ADDR_H</td><td>85h</td><td>フラッシュROMアドレスレジスタ上位バイト</td><td>xxh</td></tr>
    <tr><td>ROM_ADDR_L</td><td>84h</td><td>フラッシュROMアドレスレジスタ下位バイト</td><td>xxh</td></tr>
    <tr><td>ROM_ADDR</td><td>84h</td><td>ROM_ADDR_LとROM_ADDR_Hで16ビットSFR</td><td>xxxxh</td></tr>
    
</table>

### フラッシュROMアドレスレジスタ(ROM_ADDR):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アドレス</th><th>Description</th><th>リセット値</th>
    </tr>
    <tr><td>[7:0]</td><td>ROM_ADDR_H</td><td>RW</td><td>フラッシュROMアドレス上位バイト</td><td>xxh</td></tr>
    <tr><td>[7:0]</td><td>ROM_ADDR_L</td><td>RW</td><td>フラッシュROMアドレス下位バイト、偶数アドレスのみサポート</td><td>xxh</td></tr>
</table>

### フラッシュROMデータレジスタ(ROM_DATA):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アドレス</th><th>Description</th><th>リセット値</th>
    </tr>
    <tr><td>[7:0]</td><td>ROM_DATA_H</td><td>RW</td><td>書き込むフラッシュROMデータ上位バイト</td><td>xxh</td></tr>
    <tr><td>[7:0]</td><td>ROM_DATA_L</td><td>RW</td><td>書き込むフラッシュROMデータ下位バイト</td><td>xxh</td></tr>
</table>

### フラッシュROM制御レジスタ(ROM_CTRL):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アドレス</th><th>Description</th><th>リセット値</th>
    </tr>
    <tr><td>[7:0]</td><td>ROM_CTRL</td><td>W0</td><td>フラッシュROM制御レジスタ</td><td>00h</td></tr>
</table>

### フラッシュROMステータスレジスタ(ROM_STATUS):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アドレス</th><th>説明</th><th>リセット値</th>
    </tr>
    <tr><td>7</td><td>予約</td><td>R0</td><td>予約</td><td>1</td></tr>
    <tr><td>6</td><td>bROM_ADDR_OK</td><td>R0</td><td>フラッシュROM動作アドレス有効状態ビット:<br>ビットが0の場合、パラメータは無効<br>1はアドレスが有効</td><td>0</td></tr>
    <tr><td>[5:2]</td><td>予約</td><td>R0</td><td>予約</td><td>0000b</td></tr>
    <tr><td>1</td><td>bROM_CMD_ERR</td><td>R0</td><td>フラッシュROM動作コマンドエラーステータスビット:<br>0はコマンドが有効<br>1は不明なコマンド</td><td>0</td></tr>
    <tr><td>0</td><td>bROM_CMD_TOUT</td><td>R0</td><td>フラッシュROM動作結果ステータスビット:<br>0は操作が成功<br>1は操作がタイムアウト</td><td>0</td></tr>
</table>

## 6.5 フラッシュROM操作手順

1. フラッシュROMを消去し、ターゲット・ブロックの全データ・ビットを1に変更:
    1. セキュリティモードを有効にする、SAFE_MOD=55h; SAFE_MOD=0AAh
    2. グローバルコンフィグレーションレジスタGLOBAL_CFGを書き込み可能に設定(bCODE_WEまたはbDATA_WEはコードまたはデータに対応)
    3. アドレスレジスタROM_ADDRを設定し、16ビットのターゲットアドレスを書き込む。実際には上位6ビットのみ有効
    4. 動作制御レジスタROM_CTRLを0A6hに設定してブロック消去動作を行うと、動作中にプログラムが自動的に一時停止します
    5. 操作が終了すると、プログラムは操作を再開します。この時、ステータスレジスタROM_STATUSを参照して動作状態を確認することができます。複数のブロックを消去する場合は、(3)(4)(5)の処理を繰り返します
    6. 再びセーフモードに入る。SAFE_MOD=55h; SAFE_MOD=0AAh
    7. グローバルコンフィグレーションレジスタGLOBAL_CFGを設定して、書き込み禁止(bCODE_WE=0、bDATA_WE=0)を有効にします

2. ターゲットの2バイトのデータビットの一部を1から0に変更するためにフラッシュROMを書き込みます:
    1. セキュリティモードを有効にする、SAFE_MOD=55h; SAFE_MOD=0AAh
    2. グローバルコンフィグレーションレジスタGLOBAL_CFGを書き込み可能に設定(bCODE_WEまたはbDATA_WEはコードまたはデータに対応)
    3. アドレスレジスタROM_ADDRを設定し、16ビットのターゲットアドレスを書き込む。実際には上位15ビットのみ有効
    4. データレジスタROM_DATAをセットし、データを16ビット書き込む。(3)(4)のステップを逆にすることができます
    5. 動作制御レジスタROM_CTRLを09Ahに設定して書き込み動作を行うと、動作中にプログラムが自動的に一時停止します
    6. 操作が終了すると、プログラムは操作を再開します。この時、ステータスレジスタROM_STATUSを参照して動作状態を確認することができます。複数のブロックを書き込みする場合は、(3)(4)(5)(6)の処理を繰り返します
    7. 再びセーフモードに入る。SAFE_MOD=55h; SAFE_MOD=0AAh
    8. グローバルコンフィグレーションレジスタGLOBAL_CFGを設定して、書き込み禁止(bCODE_WE=0、bDATA_WE=0)を有効にします

3. フラッシュROM読み取り:
    1. MOVC命令を使用して直接、またはプログラムメモリ空間へのポインタを使用して、ターゲットアドレスのコードやデータを読み出すことができます

## 6.6 オンボードプログラミングとISPダウンロード

構成情報Code_Protect=1の時、CH559チップのフラッシュROM内のコードとデータを外部プログラマが同期シリアルインタフェースを介して読み書きすることができます。構成情報Code_Protect=0の時、フラッシュROM内のコードとデータは保護されます。読み出すことはできませんが、消去し、消去後に電源を入れ直すことでコード保護を解除することができます。

CH559チップがBootLoaderブートローダでプリインストールされている場合、CH559は、アプリケーションをロードするためにUSBや非同期シリアルポートなどの複数のISPダウンロード方法をサポートすることができますが、ブートローダはありません。CH559は外部の専用プログラマがブートローダに書き込むことしかできません。またはアプリケーションです。オンボード・プログラミングをサポートするために、CH559とプログラマ間の接続ピンを5本、回路内に予約する必要があります。

<div>
    <p align="center">表6.6.1 プログラマへの接続ピン</p>
</div>

<table>
    <tr>
        <th>ピン</th><th>GPIO</th><th>ピン説明</th>
    </tr>
    <tr><td>RST</td><td>P5.7</td><td>プログラミング状態のリセットコントロールピン。HIGHレベルでプログラミング状態</td></tr>
    <tr><td>SCS</td><td>P1.4</td><td>チップセレクト入力端子(プログラミング状態)、デフォルトHIGHレベル、アクティブLOW</td></tr>
    <tr><td>SCK</td><td>P1.7</td><td>プログラミング状態のクロック入力端子</td></tr>
    <tr><td>MOSI</td><td>P1.5</td><td>プログラミング状態のデータ入力端子</td></tr>
    <tr><td>MISO</td><td>P1.6</td><td>プログラミング状態のデータ出力端子</td></tr>
</table>

## 6.7 チップユニークID番号

各マイコンには、チップ識別番号と呼ばれる固有のID番号が出荷に付与されます。IDデータとそのチェックサムは合計8バイトで、専用リードオンリーメモリのオフセットアドレスが20hになる領域に格納されています。グローバル割り込みをクローズし、E_DISが1の期間に同様にコードフラッシュを読み出すことで取得することができます。動作はC言語のサンプルプログラムGETID.Cを参照してください。

<div>
    <p align="center">表6.7.1 チップIDアドレステーブル</p>
</div>

<table>
    <tr>
        <th>オフセットアドレス</th><th>IDデータ概要</th>
    </tr>
    <tr><td>20h, 21h</td><td>ID番号の最初のワードデータの後に、下位バイトと次の下位バイトが続きます</td></tr>
    <tr><td>22h, 23h</td><td>IDセカンドワードデータの後に、ID番号の次の上位バイトが続きます</td></tr>
    <tr><td>24h, 25h</td><td>ID最後のワードデータの後に、48ビットのID番号の次の上位バイトと上位バイトが続く</td></tr>
    <tr><td>26h, 27h</td><td>ID検証に使用されるIDの最初のワード、第2ワード、最後のワードデータの16ビットの累積合計</td></tr>
</table>

ID番号は、ダウンロードツールで対象のプログラムを暗号化する際に使用することができます。一般的なアプリケーションでは、ID番号の最初の32桁だけを使用してください。
