---
title: 7. パワーマネージメント
type: docs
weight: 7
BookToC: false
---

# 7. パワーマネージメント、スリープとリセット

## 7.1 外部電源入力

CH559チップの内部動作電圧は3.3Vで、I/O端子の入出力電圧は3.3Vです。P1.0～P1.7、XI、XO、RSTを除くI/O端子は5Vの電圧入力に耐えることができます。CH559チップには5Vから3.3Vの低ドロップアウト電圧レギュレータが搭載されており、外部からの3.3Vまたは5Vの電源電圧入力に対応しています。2つの電源電圧入力モードは下表を参照してください。

<table>
    <tr>
        <th>外部電源電圧</th><th>VIN5ピン電圧: 外部電圧3.3V～5V</th><th>VDD33ピン電圧：内部電圧3.3V</th>
    </tr>
    <tr><td>3.3V(3.6V以下)</td><td>電圧レギュレータへの入力外部3.3V電圧は、0.1uF以上のデカップリングコンデンサを接続する必要があります</td><td>内部動作電源として外部3.3Vを入力し、0.1u以上のデカップリングコンデンサを接続する必要があります</td></tr>
    <tr><td>5V(3.6V超)</td><td>入力外部5V電圧を電圧レギュレータに、0.1uF以上のデカップリングコンデンサを接続する必要があります</td><td>内部電圧レギュレータ3.3V出力と3.3V内部動作電源入力は、3.3uF以上のデカップリングコンデンサを接続する必要があります</td></tr>
</table>

電源を入れるか、システムをリセットすると、CH559はデフォルトで動作しています。一部の機能モジュールが不要な場合は、これらのモジュールのクロックをオフにして、消費電力を削減することができます。CH559を動作させる必要がない場合は、PCONのPDをスリープ状態に設定することができます。スリープ状態では、USB、UART0、UART1、SPI0、一部のGPIOを介して外部ウェイクアップを選択することができます。

## 7.2 電源およびスリープ制御レジスタ

<div>
    <p align="center">表7.2.1 電源およびスリープ制御レジスタ一覧</p>
</div>

<table>
    <tr>
        <th>名前</th><th>アドレス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>WDOG_COUNT</td><td>FFh</td><td>ウォッチドッグカウントレジスタ</td><td>00h</td></tr>
    <tr><td>RESET_KEEP</td><td>FEh</td><td>リセット保持レジスタ</td><td>00h</td></tr>
    <tr><td>WAKE_CTRL</td><td>EBh</td><td>スリープウェイク制御レジスタ</td><td>00h</td></tr>
    <tr><td>SLEEP_CTRL</td><td>EAh</td><td>スリープ制御レジスタ</td><td>00h</td></tr>
    <tr><td>PCON</td><td>87h</td><td>電源制御レジスタ</td><td>10h</td></tr>   
</table>

### ウォッチドッグカウントレジスタ(WDOG_COUNT):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アクセス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>[7:0]</td><td>WDOG_COUNT</td><td>RW</td><td>ウォッチドッグの現在のカウントは 0FFh です。<br />00h になるとオーバーフローします。<br />オーバーフローすると自動的に割り込みフラグbWDOG_IF_TOを1に設定します。</td><td>00h</td></tr>
</table>

### リセット保持レジスタ(RESET_KEEP):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アクセス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>[7:0]</td><td>RESET_KEEP</td><td>RW</td><td>保持レジスタをリセットし、値を手動で変更することができます。<br />パワーオンリセットを除いて、他のどのリセットも値に影響を与えません。</td><td>00h</td></tr>
</table>

### スリープウェイク制御レジスタ(WAKE_CTRL), セーフモードでのみ書き込み可能:
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アクセス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>7</td><td>bWAK_BY_USB</td><td>RW</td><td>USBイベントウェイクアップ有効。<br />0: ウェイクアップは許可されていません。</td><td>0</td></tr>
    <tr><td>6</td><td>bWAK_RXD1_LO</td><td>RW</td><td>UART1のLOW入力受信ウェイクアップ。<br />0: ウェイクアップが無効になります。<br />iRS485モードではXA/XB差動入力を選択し、非iRS485モードではbIER_PIN_MOD1=1/0によりRXD1またはRXD1_端子を選択します。</td><td>0</td></tr>
    <tr><td>5</td><td>bWAK_P1_5_LO</td><td>RW</td><td>P1.5のLOWウェイクアップ有効。<br />0: ウェイクアップは許可されていません。</td><td>0</td></tr>
    <tr><td>4</td><td>bWAK_P1_4_LO</td><td>RW</td><td>P1.4のLOWウェイクアップ有効。<br />0: ウェイクアップは許可されていません。</td><td>0</td></tr>
    <tr><td>3</td><td>bWAK_P0_3_LO</td><td>RW</td><td>P0.3のLOWウェイクアップ有効。<br />0: ウェイクアップは許可されていません。</td><td>0</td></tr>
    <tr><td>2</td><td>bWAK_CAP3_LO</td><td>RW</td><td>Timer3のLOWウェイクアップキャプチャ有効。<br />0: ウェイクアップは許可されていません。<br />bTMR3_PIN_X=0/1に従ってCAP3またはCAP3_端子を選択してください。</td><td>0</td></tr>
    <tr><td>1</td><td>bWAK_P3_2E_3L</td><td>RW</td><td>P3.2のエッジ変更とP3.3のLOWウェイクアップ有効。<br />0: ウェイクアップは許可されていません。</td><td>0</td></tr>
    <tr><td>0</td><td>bWAK_RXD0_LO</td><td>RW</td><td>UART0のLOW入力受信ウェイクアップ。<br />0: ウェイクアップが無効になります。<br />bUART0_PIN_X=0/1でRXD0またはRXD0_端子を選択します。</td><td>0</td></tr>
</table>

### スリープ制御レジスタ(WAKE_CTRL), セーフモードでのみ書き込み可能:
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アクセス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>7</td><td>bSLP_OFF_USB</td><td>RW</td><td>USBクロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>6</td><td>bSLP_OFF_ADC</td><td>RW</td><td>ADCクロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>5</td><td>bSLP_OFF_UART1</td><td>RW</td><td>UAR1クロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>4</td><td>bSLP_OFF_P1S1</td><td>RW</td><td>PWM1/SPI1クロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>3</td><td>bSLP_OFF_SPI0</td><td>RW</td><td>SPI0クロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>2</td><td>bSLP_OFF_TMR3</td><td>RW</td><td>Timer3クロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>1</td><td>bSLP_OFF_LED</td><td>RW</td><td>LED-CTRLクロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
    <tr><td>0</td><td>bSLP_OFF_XRAM</td><td>RW</td><td>xRAMクロックオフ制御。<br />1: クロックオフ</td><td>0</td></tr>
</table>

### 電源制御レジスタ(PCON):
<table>
    <tr>
        <th>ビット</th><th>名前</th><th>アクセス</th><th>概要</th><th>リセット値</th>
    </tr>
    <tr><td>7</td><td>SMOD</td><td>RW</td><td>Timer1を使用してUART0のボーレートを生成する場合は、UART0モード1、2、3の通信ボーレートを選択します。<br />0 :スローモード<br />1: 高速モード</td><td>0</td></tr>
    <tr><td>6</td><td>reserved</td><td>RO</td><td>予約</td><td>0</td></tr>
    <tr><td>5</td><td>bRST_FLAG1</td><td>R0</td><td>チップラストリセットフラグ上位</td><td>0</td></tr>
    <tr><td>4</td><td>bRST_FLAG0</td><td>R0</td><td>チップラストリセットフラグ下位</td><td>1</td></tr>
    <tr><td>3</td><td>GF1</td><td>RW</td><td>ユニバーサルフラグ<br />1: ユーザーは自身で定義することができます。ソフトウェアによって値の設定が可能です。</td><td>0</td></tr>
    <tr><td>2</td><td>GF0</td><td>RW</td><td>グローバルフラグ<br />1: ユーザーは自身で定義することができます。ソフトウェアによって値の設定が可能です。</td><td>0</td></tr>
    <tr><td>1</td><td>PD</td><td>RW</td><td>スリープモードを有効にします。<br />1: ウェイクアップハードウェアが自動的にクリアしたあとにスリーブします</td><td>0</td></tr>
    <tr><td>0</td><td>reserved</td><td>R0</td><td>予約</td><td>0</td></tr>
</table>

<div>
    <p align="center">表7.2.2 チップラストリセットフラグの説明</p>
</div>

<table>
    <tr>
        <th>bRST_FLAG1</th><th>bRST_FLAG0</th><th>リセットフラグの概要</th>
    </tr>
    <tr><td>0</td><td>0</td><td>ソフトウェアリセット。<br />bSW_RESET=1で(bBOOT_LOAD=0またはbWDOG_EN=1)</td></tr>
    <tr><td>0</td><td>1</td><td>パワーオンリセット。<br />VDD33端子電圧が検出レベル以下</td></tr>
    <tr><td>1</td><td>0</td><td>ウォッチドッグリセット。<br />bWDOG_EN=1でウォッチドッグタイムアウト</td></tr>
    <tr><td>1</td><td>1</td><td>外部端子により手動リセット。<br />En_P5.7_RESET=1でP5.7がHIGH</td></tr>
</table>

## 7.3 リセット制御

CH559のリセットソースは、パワーオンリセット、外部リセット、ソフトウェアリセット、ウォッチドッグリセットの4つで、後者の3つはホットリセットです。

### 7.3.1 パワーオンリセット

パワーオンリセットのPORは、内蔵の電圧検出回路により生成されます。この回路はVDD33端子の電源電圧を常時監視しています。検出レベル以下になるとVpotがパワーオンリセットを発生させ、ハードウェアが自動的にTporを遅延させてリセット状態を維持します。遅延時間が経過するとCH559が動作します。パワーオンリセットのみで、CH559は構成情報をリロードし、RESET_KEEPをクリアします。他のサーマルリセットは影響しません。

### 7.3.2 外部リセット

RST端子にハイレベルが印加されることで外部リセットが発生します。リセット処理は、コンフィギュレーション情報En_P5.7_RESETが1で、RSTピンのHIGHレベルがTrstより長く続くとトリガされます。外部ハイレベル信号がキャンセルされると、ハードウェアは自動的にTrdlを遅延させてリセット状態を維持します。遅延が切れた後、CH559は0アドレスからスタートします。

### 7.3.3 ソフトウェアリセット

CH559 は、外部からの介入なしに CPU の状態を積極的にリセットして再実行するための内部ソフトウェアリセットをサポートしています。グローバル・コンフィギュレーション・レジスタGLOBAL_CFGのbSW_RESETを1に設定すると、ソフトウェア・リセットを行い、自動的にTrdlを遅延させてリセット状態を維持します。遅延時間が経過すると、CH559は0アドレスからスタートし、ハードウェアによりbSW_RESETビットは自動的にクリアされます。

bSW_RESETが設定されている場合、bBOOT_LOAD=0またはbWDOG_EN=1の場合、bRST_FLAG1/0はリセット後のソフトウェアリセットを指示します。bSW_RESETが1に設定され、bBOOT_LOAD=1、bWDOG_EN=0の場合、bRST_FLAG1/0は新たなリセットフラグを生成せず、前回のリセットフラグを変更せずに保持します。

ISP ブートプログラムを搭載したチップの場合、パワーオンリセット後にブートプログラムを実行すると、ソフトウェアリセットに従ってチップがアプリケーション状態にリセットされます。このソフトウェアリセットは bBOOT_LOAD をクリアするだけで、bRST_FLAG1/0 の状態には影響しません。(リセット前はbBOOT_LOAD=1なので)アプリケーション状態に切り替わっても、bRST_FLAG1/0はパワーオンリセット状態を示します。

### 7.3.4 ウォッチドッグリセット

ウォッチドッグタイマーがタイムアウトすると、ウォッチドッグリセットが発生します。ウォッチドッグタイマーは、システムのメイン周波数であるFsys/262144のクロック周波数をカウントする8ビットカウンタです。0FFhが00hになるとオーバーフロー信号が発生します。

ウォッチドッグタイマオーバーフロー信号により割り込みフラグbWDOG_IF_TOが1になります。この値は、WDOG_COUNTがリロードされたとき、または対応する割り込みサービスルーチンが入力されたときに自動的にクリアされます。

異なるタイミング期間Twdcは、WDOG_COUNTに異なるカウント初期値を書き込むことで達成されます。12MHzでは、00hでのウォッチドッグタイミング期間Twdcは約5.9秒、80hでは約2.8秒です。

ウォッチドッグタイマがオーバーフローしたときにbWDOG_EN=1になると、ウォッチドッグリセットが発生し、リセット状態を維持するためにTrdlを自動的に遅延させる。遅延終了後、CH559は0アドレスからスタートします。

bWDOG_EN=1の時にウォッチドッグからリセットされないように、WDOG_COUNTはオーバーフローを避けるために時間内にリセットする必要があります。
